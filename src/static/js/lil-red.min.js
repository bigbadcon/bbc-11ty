var lilRed=(()=>{var m=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var N=(e,t)=>{for(var o in t)m(e,o,{get:t[o],enumerable:!0})},L=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of D(t))!E.call(e,s)&&s!==o&&m(e,s,{get:()=>t[s],enumerable:!(n=$(t,s))||n.enumerable});return e};var k=e=>L(m({},"__esModule",{value:!0}),e);var B={};N(B,{admin:()=>G,bookings:()=>q,decodeText:()=>O,destroy:()=>S,events:()=>F,favorites:()=>K,fetcher:()=>R,init:()=>U,isAdmin:()=>j,lilDelete:()=>h,lilFetch:()=>c,lilGet:()=>r,lilPost:()=>i,lilPut:()=>y,login:()=>x,logout:()=>A,me:()=>z,password:()=>C,roles:()=>M,status:()=>T});var v={lilRedApiUrl:null,logoutIfStale:!0,daysTillLogout:10,serverApiKey:null},l,f="lilRedAuthToken",g="lilRedLastLogin";function a(e,t,o,n=!0){typeof t=="string"&&/^ERROR/.test(t)?console.error(e,t,o):console.log(e,t),document.dispatchEvent(new CustomEvent(e,{bubbles:n,detail:t}))}var O=e=>{try{let t=new TextEncoder("windows-1251"),o=new TextDecoder;return e&&o.decode(t.encode(e))}catch(t){return console.error("decodeText: "+t),e}};async function R(e,t){try{let o=await fetch(e,t);if(console.log(`RESPONSE:lilFetch for ${e}`,o),o.status!==200)throw new Error(`fetch fail status: ${o.status}`);let n=o.headers.get("content-type"),s=n&&n.indexOf("application/json")!==-1?await o.json():await o.text();return console.log(`RESULT: lilFetch for ${e}`,s),s}catch(o){return a("lil-red-fetch-error",`ERROR: lilFetch for ${e} failed`,o),null}}async function P(e,t){if(!l&&l.lilRedApiUrl)return null;let o=l.lilRedApiUrl+"/login",n={method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify({username:e,password:t})};try{let s=await fetch(o,n);if(s.status===200&&s.headers.get("authorization")){let u=s.headers.get("authorization");return localStorage.setItem(f,u),localStorage.setItem(g,new Date().toISOString()),a("lil-red-login","success"),u}}catch{return a("lil-red-login","fail"),null}}async function c(e){if(e={jsonStringify:!0,method:"GET",publicMethod:!1,...e},!l?.lilRedApiUrl||!e.api)return null;let t=e.publicMethod||e.api==="/"||/public/.test(e.api),o=e.serverApiKey||l.serverApiKey,n=l.lilRedApiUrl+e.api,s={method:e.method,headers:{}};if(e.jsonStringify&&(e.body=e.body&&JSON.stringify(e.body),s.headers["Content-Type"]="application/json;charset=utf-8"),e.body&&(s.body=e.body),!t&&!e.serverApiKey){let d=e.token||localStorage.getItem(f);if(d)s.headers.Authorization=d;else return a("lil-red-fetch","ERROR: auth token missing"),null;if(l.logoutIfStale){let p=Date.parse(localStorage.getItem(g)),b=new Date,I=l.daysTillLogout||10,w=Date.parse(new Date(b.setDate(b.getDate()-I)));if(isNaN(p)||isNaN(w)||p<w)return a("lil-red-fetch",`ERROR: auth token stale. Last Login: ${p}`),A(),null}s.headers.Authorization=d}return!t&&o&&(s.headers["x-api-key"]=o),await R(n,s)}var r=(e,t)=>c({api:e,...t}),i=(e,t,o)=>c({api:e,method:"POST",body:t,...o}),y=(e,t,o)=>c({api:e,method:"PUT",body:t,...o}),h=(e,t,o)=>c({api:e,method:"DELETE",body:t,...o});async function U(e){return S(),l={...v,...e},console.log("\u{1F43A} Initializing LilRed",l),a("lil-red-init",`Initializing Lil Red: ${l.lilRedApiUrl}`),await T()}function S(){let e=l?.lilRedApiUrl;l=v,e&&a("lil-red-destroy",`Deinitialized -- no longer using ${e}`)}var T=async()=>{let e=await r("/");return a("lil-red-status",e),e},x=(e,t)=>P(e,t),A=()=>{a("lil-red-logout","You have been logged out of Lil Red"),localStorage.removeItem(f),localStorage.removeItem(g)},j=()=>r("/users/me/isadmin"),z=()=>r("/users/me"),M=async e=>(e=e||await r("/users/me"),[...e.metadata.find(n=>/capabilities/.test(n.metaKey)).metaValue.matchAll(/"([a-z-]+)/g)].map(n=>n[1])),q={slots:()=>r("/bookings/myAvailableSlots"),get:()=>r("/events/me"),add:e=>i("/bookings/bookMeIntoGame",{gameId:Number(e)}),delete:e=>h("/bookings/removeMeFromGame",{gameId:Number(e)})},K={get:()=>r("/events/me/favorites"),add:e=>i("/events/me/favorite/create",{eventId:Number(e)}),delete:e=>h("/events/me/favorite/delete",{eventId:Number(e)})},C={set:(e,t)=>i("/users/setMyPassword",{userId:Number(e),password:t}),requestReset:e=>i("/users/resetPasswordRequest",{email:e}),mailRequest:(e,t,o)=>i("/password/request",{emailAddress:e,emailBody:t,emailSubject:o}),reset:(e,t,o)=>i("/password/reset",{emailAddress:e,password:t,uuid:o}),confirm:(e,t)=>i("/users/confirmPasswordRequest",{password:e,token:t})},F={me:()=>r("/events/me"),find:e=>i("/events/find",{id:Number(e)}),all:()=>r("/events/all"),category:e=>r(`/events/category/${e}`),count:()=>r("/events/count"),create:e=>y("/users/setMyPassword",e),uploadImage:e=>{c({api:"/events/image",method:"POST",body:e,jsonStringify:!1})},currentYear:(e,t)=>r(`/events/page/${e}/${t}`),since:e=>r(`/events/since/${e}`),public:{all:()=>r("/events/all/public"),currentYear:(e,t)=>r(`/events/page/public/${e}/${t}`),spaces:()=>r("/events/spaces/public"),space:e=>r(`/events/${e}/spaces/public`),categories:async e=>{e=e||await r("/events/all/public");let t=e.reduce((n,s)=>{let u=s.categories.map(d=>d.name)||[];return[...n,...u]},[]);return[...new Set(t)]}}},G={roles:{add:(e,t)=>i("/events/addRoleToUser",{userId:Number(e),role:t}),delete:(e,t)=>i("/events/removeRoleFormUser",{userId:Number(e),role:t})},users:{all:()=>r("/users/all"),create:e=>y("/users/create",e),findById:e=>r(`/users/id/${e}`),findByEmail:e=>r(`/users/email/${e}`),setPassword:(e,t)=>i("/users/setPassword",{password:t,userId:e})},bookings:{add:()=>{},delete:()=>{},setGm:()=>{}}};return k(B);})();
//# sourceMappingURL=lil-red.min.js.map
