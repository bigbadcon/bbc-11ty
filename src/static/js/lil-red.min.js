var lilRed=(()=>{var m=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var L=(e,t)=>{for(var o in t)m(e,o,{get:t[o],enumerable:!0})},O=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of k(t))!E.call(e,s)&&s!==o&&m(e,s,{get:()=>t[s],enumerable:!(n=D(t,s))||n.enumerable});return e};var P=e=>O(m({},"__esModule",{value:!0}),e);var B={};L(B,{admin:()=>G,bookings:()=>q,decodeText:()=>R,destroy:()=>T,events:()=>N,favorites:()=>K,fetcher:()=>S,init:()=>x,isAdmin:()=>j,lilDelete:()=>h,lilFetch:()=>d,lilGet:()=>r,lilPost:()=>i,lilPut:()=>g,login:()=>C,logout:()=>I,me:()=>z,password:()=>F,roles:()=>M,status:()=>A});var v={lilRedApiUrl:null,logoutIfStale:!0,daysTillLogout:10,serverApiKey:null},l,f="lilRedAuthToken",y="lilRedLastLogin";function u(e,t,o,n=!0){typeof t=="string"&&/^ERROR/.test(t)?console.error(e,t,o):console.log(e,t),document.dispatchEvent(new CustomEvent(e,{bubbles:n,detail:t}))}var R=e=>{try{let t=new TextEncoder("windows-1251"),o=new TextDecoder;return e&&o.decode(t.encode(e))}catch(t){return console.error("decodeText: "+t),e}};async function S(e,t){try{let o=await fetch(e,t);if(console.log(`RESPONSE:lilFetch for ${e}`,o),o.status!==200)throw new Error(`fetch fail status: ${o.status}`);let n=o.headers.get("content-type"),s=n&&n.indexOf("application/json")!==-1?await o.json():await o.text();return console.log(`RESULT: lilFetch for ${e}`,s),s}catch(o){return u("lil-red-fetch-error",`ERROR: lilFetch for ${e} failed`,o),null}}async function U(e,t){if(!l&&l.lilRedApiUrl)return null;let o=l.lilRedApiUrl+"/login",n={method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify({username:e,password:t})};try{let s=await fetch(o,n);if(s.status===200&&s.headers.get("authorization")){let a=s.headers.get("authorization");return localStorage.setItem(f,a),localStorage.setItem(y,new Date().toISOString()),u("lil-red-login","success"),a}}catch{return u("lil-red-login","fail"),null}}async function d(e){if(e={jsonStringify:!0,method:"GET",publicMethod:!1,...e},!l?.lilRedApiUrl||!e.api)return null;let t=e.publicMethod||e.api==="/"||/public/.test(e.api),o=e.serverApiKey||l.serverApiKey,n=l.lilRedApiUrl+e.api,s={method:e.method,headers:{}};if(e.jsonStringify&&(e.body=e.body&&JSON.stringify(e.body),s.headers["Content-Type"]="application/json;charset=utf-8"),e.body&&(s.body=e.body),!t&&!e.serverApiKey){let c=e.token||localStorage.getItem(f);if(c)s.headers.Authorization=c;else return u("lil-red-fetch","ERROR: auth token missing"),null;if(l.logoutIfStale){let p=Date.parse(localStorage.getItem(y)),b=new Date,$=l.daysTillLogout||10,w=Date.parse(new Date(b.setDate(b.getDate()-$)));if(isNaN(p)||isNaN(w)||p<w)return u("lil-red-fetch",`ERROR: auth token stale. Last Login: ${p}`),I(),null}s.headers.Authorization=c}return!t&&o&&(s.headers["x-api-key"]=o),await S(n,s)}var r=(e,t)=>d({api:e,...t}),i=(e,t,o)=>d({api:e,method:"POST",body:t,...o}),g=(e,t,o)=>d({api:e,method:"PUT",body:t,...o}),h=(e,t,o)=>d({api:e,method:"DELETE",body:t,...o});async function x(e){return T(),l={...v,...e},console.log("\u{1F43A} Initializing LilRed",l),u("lil-red-init",`Initializing Lil Red: ${l.lilRedApiUrl}`),await A()}function T(){let e=l?.lilRedApiUrl;l=v,e&&u("lil-red-destroy",`Deinitialized -- no longer using ${e}`)}var A=async()=>{let e=await r("/");return u("lil-red-status",e),e},C=(e,t)=>U(e,t),I=()=>{u("lil-red-logout","You have been logged out of Lil Red"),localStorage.removeItem(f),localStorage.removeItem(y)},j=()=>r("/users/me/isadmin"),z=()=>r("/users/me"),M=async e=>(e=e||await r("/users/me"),[...e.metadata.find(n=>/capabilities/.test(n.metaKey)).metaValue.matchAll(/"([a-z-]+)/g)].map(n=>n[1])),q={slots:()=>r("/bookings/myAvailableSlots"),get:()=>r("/events/me"),add:e=>i("/bookings/bookMeIntoGame",{gameId:Number(e)}),delete:e=>h("/bookings/removeMeFromGame",{gameId:Number(e)}),event:async(e,t)=>{t||(t=await N.find(e));let o=t.bookings.filter(a=>a.bookingStatus===1).map(a=>({...a,user:{...a.user,displayName:R(a.user.displayName)}})),n=o.filter(a=>a.bookingComment).sort((a,c)=>a.user.displayName.localeCompare(c.user.displayName))||[],s=o.filter(a=>!a.bookingComment).sort((a,c)=>a.user.displayName.localeCompare(c.user.displayName))||[];return{facilitator:n,attendees:s}}},K={get:()=>r("/events/me/favorites"),add:e=>i("/events/me/favorite/create",{eventId:Number(e)}),delete:e=>h("/events/me/favorite/delete",{eventId:Number(e)})},F={set:(e,t)=>i("/users/setMyPassword",{userId:Number(e),password:t}),requestReset:e=>i("/users/resetPasswordRequest",{email:e}),mailRequest:(e,t,o)=>i("/password/request",{emailAddress:e,emailBody:t,emailSubject:o}),reset:(e,t,o)=>i("/password/reset",{emailAddress:e,password:t,uuid:o}),confirm:(e,t)=>i("/users/confirmPasswordRequest",{password:e,token:t})},N={me:()=>r("/events/me"),find:e=>i("/events/find",{id:Number(e)}),all:()=>r("/events/all"),category:e=>r(`/events/category/${e}`),count:()=>r("/events/count"),create:e=>g("/users/setMyPassword",e),uploadImage:e=>{d({api:"/events/image",method:"POST",body:e,jsonStringify:!1})},currentYear:(e,t)=>r(`/events/page/${e}/${t}`),since:e=>r(`/events/since/${e}`),public:{all:()=>r("/events/all/public"),currentYear:(e,t)=>r(`/events/page/public/${e}/${t}`),spaces:()=>r("/events/spaces/public"),space:e=>r(`/events/${e}/spaces/public`),categories:async e=>{e=e||await r("/events/all/public");let t=e.reduce((n,s)=>{let a=s.categories.map(c=>c.name)||[];return[...n,...a]},[]);return[...new Set(t)]}}},G={roles:{add:(e,t)=>i("/events/addRoleToUser",{userId:Number(e),role:t}),delete:(e,t)=>i("/events/removeRoleFormUser",{userId:Number(e),role:t})},users:{all:()=>r("/users/all"),create:e=>g("/users/create",e),findById:e=>r(`/users/id/${e}`),findByEmail:e=>r(`/users/email/${e}`),setPassword:(e,t)=>i("/users/setPassword",{password:t,userId:e})},bookings:{add:()=>{},delete:()=>{},setGm:()=>{}}};return P(B);})();
//# sourceMappingURL=lil-red.min.js.map
